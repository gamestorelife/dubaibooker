// Define bookingData globally so it can be accessed inside the form submit handler
let bookingData = {};

function toggleTextarea(enable) {
  const textarea = document.getElementById("comments");
  textarea.disabled = !enable;
}

// Disable the textarea initially if "No" is selected by default
document.addEventListener("DOMContentLoaded", function () {
  const noSelected = document.getElementById("insurance2").checked;
  toggleTextarea(!noSelected);
});

// Fetch the booking data from the server when the DOM is fully loaded
document.addEventListener("DOMContentLoaded", async () => {
  function toggleTextarea(enable) {
    const textarea = document.getElementById("comments");
    textarea.disabled = !enable;
  }

  // Disable the textarea initially if "No" is selected by default
  document.addEventListener("DOMContentLoaded", function () {
    const noSelected = document.getElementById("insurance2").checked;
    toggleTextarea(!noSelected);
  });

  try {
    const response = await fetch("/retrieve-apartment-booking");
    const result = await response.json();

    if (response.ok && result.data) {
      // Assign fetched data to the global bookingData variable
      bookingData = result.data;

      // Render booking data
      let detailsHTML = `
     <div>
     <label id="phone-label" for="phone">
        <strong>Selected Details</strong>
        </label>
         <div class="d-flex">
            <div class="date-in-jw">
             <p>Check in date</p>
            </div>

           <div class="date-out-jw">
             <p>${bookingData.checkInDate}</p>
           </div>
         </div>
          <div class="d-flex">
            <div class="date-in-jw">
              <p>Check Out date</p>
            </div>

           <div class="date-out-jw">
           <p>${bookingData.checkOutDate}</p>
          </div>
         </div>
        <div class="d-flex">
         <div class="date-in-jw">
          <p>Adults</p>
         </div>

          <div class="date-out-jw">
           <p> ${bookingData.adults}</p>
           </div>
        </div>


    </div>`;

      // If children were selected, display their count and ages
      if (bookingData.children > 0) {
        detailsHTML += `
                 <div class="d-flex">
                        <div class="date-in-jw">
                         <p>children</p>
                        </div>

                        <div class="date-out-jw">
                           <p>${bookingData.children}</p>
                        </div>
                </div>`;
        if (bookingData.childAges.length > 0) {
          detailsHTML += `
           <div class="d-flex">
                        <div class="date-in-jw">
                         <p>children Ages</p>
                        </div>

                        <div class="date-out-jw">
                           <p>${bookingData.childAges.join(", ")}</p>
                        </div>
                </div>
          `;
        }
      }

      document.getElementById("booking-details").innerHTML = detailsHTML;
    } else {
      document.getElementById("booking-details").innerHTML =
        "<p>No booking data found.</p>";
    }
  } catch (error) {
    console.error("Error fetching booking data:", error);
    document.getElementById("booking-details").innerHTML =
      "<p>Error retrieving booking data.</p>";
  }
});

// Form submission handler
document
  .getElementById("book-form")
  .addEventListener("submit", async function (event) {
    event.preventDefault(); // Prevent default form submission

    const myDialog = document.getElementById("my-dialog");
    myDialog.showModal();
    const formData = {
      villaname: document.getElementById("villaname").value,
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value,
      insurance: document.querySelector('input[name="insurance"]:checked')
        .value,
      comments: document.getElementById("comments").value,
      // Use the global bookingData variable
      bookingDetails: {
        checkInDate: bookingData.checkInDate,
        checkOutDate: bookingData.checkOutDate,
        adults: bookingData.adults,
        children: bookingData.children,
        childAges: bookingData.childAges,
      },
    };

    try {
      const response = await fetch("/send-booking-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });

      const result = await response.json();
      if (response.ok) {
        alert("Booking email sent successfully!");
        window.location.href = "/index.html";
      } else {
        alert("Failed to send booking email: " + result.message);
        myDialog.close();
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred while sending booking email.");
    }
  });
